<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Display</title>

    <!-- PWA / Hemskärm-stöd -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Display">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#B8123D">
    <script src="../qrcode.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            padding-left: calc(20px + env(safe-area-inset-left));
            padding-right: calc(20px + env(safe-area-inset-right));
            background-color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #B8123D;
        }

        .header .club-logo {
            height: 60px;
        }

        .header .club-title {
            font-size: 28px;
            font-weight: 700;
            color: #B8123D;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .left-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-bottom: 120px;
        }

        .order-section {
            flex: 1;
        }

        .order-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .cart-items {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: calc(100vh - 350px);
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 18px;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-name {
            font-weight: 500;
        }

        .cart-item-details {
            color: #666;
            text-align: right;
        }

        .cart-item-price {
            font-weight: 600;
            margin-left: 15px;
        }

        .empty-cart {
            text-align: center;
            color: #999;
            padding: 30px;
            font-size: 18px;
        }

        .qr-section {
            background: #f0f7f0;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin-top: 20px;
        }

        .qr-section.hidden {
            display: none;
        }

        .qr-title {
            font-size: 20px;
            font-weight: 500;
            color: #333;
            margin-bottom: 15px;
        }

        .qr-container {
            display: inline-block;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .qr-container canvas,
        .qr-container img {
            display: block;
        }

        /* Mobilanpassning */
        @media (max-width: 500px) {
            .qr-container canvas,
            .qr-container img {
                width: 150px !important;
                height: 150px !important;
            }

            .qr-section {
                margin-bottom: 120px;
            }
        }

        .qr-amount {
            font-size: 36px;
            font-weight: bold;
            color: #2e7d32;
            margin-top: 15px;
        }

        .total-section {
            text-align: center;
            padding: 10px 20px;
            background: #B8123D;
            color: white;
            border-radius: 8px;
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom));
            left: calc(20px + env(safe-area-inset-left));
            right: calc(20px + env(safe-area-inset-right));
            max-width: calc(600px - 40px);
            margin: 0 auto;
            z-index: 100;
        }

        .total-section.no-items {
            background: #ccc;
        }

        .total-label {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .total-amount {
            font-size: 32px;
            font-weight: bold;
        }

        .status-indicator {
            position: fixed;
            top: calc(10px + env(safe-area-inset-top));
            right: calc(10px + env(safe-area-inset-right));
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            background: #ccc;
            color: white;
        }

        .status-indicator.connected {
            background: #4caf50;
        }

        .status-indicator.disconnected {
            background: #f44336;
        }

        /* Desktop-layout: QR till höger, större text */
        @media (min-width: 800px) {
            body {
                max-width: 1200px;
                padding: 30px 40px;
            }

            .header .club-logo {
                height: 80px;
            }

            .header .club-title {
                font-size: 36px;
            }

            .main-content {
                flex-direction: row;
                gap: 40px;
                align-items: flex-start;
            }

            .left-column {
                flex: 1;
                padding-bottom: 0;
            }

            .order-title {
                font-size: 24px;
                text-align: left;
            }

            .cart-item {
                font-size: 26px;
                padding: 15px 0;
            }

            .cart-item-price {
                margin-left: 25px;
            }

            .empty-cart {
                font-size: 24px;
            }

            .cart-items {
                max-height: calc(100vh - 400px);
            }

            .total-section {
                position: static;
                padding: 15px 25px;
                max-width: none;
                left: auto;
                right: auto;
                bottom: auto;
            }

            .total-label {
                font-size: 16px;
            }

            .total-amount {
                font-size: 42px;
            }

            .qr-section {
                margin-top: 0;
                padding: 30px;
                min-width: 380px;
            }

            .qr-title {
                font-size: 22px;
            }

            .qr-amount {
                font-size: 42px;
            }
        }
    </style>
</head>
<body>
    <div class="status-indicator" id="status">Ansluter...</div>

    <div class="header">
        <img src="../Logga.png" alt="Årsta AIK" class="club-logo">
        <span class="club-title">Årsta AIK</span>
    </div>

    <div class="main-content">
        <div class="left-column">
            <div class="order-section">
                <div class="order-title">Din order</div>
                <div class="cart-items" id="cart"></div>
            </div>

            <div class="total-section" id="total-section">
                <div class="total-label">Att betala</div>
                <div class="total-amount" id="total-amount">0 kr</div>
            </div>
        </div>

        <div class="qr-section" id="qr-section">
            <div class="qr-title">Betala med Swish</div>
            <div class="qr-container" id="qr-container"></div>
            <div class="qr-amount" id="qr-amount"></div>
        </div>
    </div>

    <script>
        // Firebase-konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyDmNoYcJm8WzrQVC0F1Q_6XCUGhvrOKD7Y",
            authDomain: "kassa-e757b.firebaseapp.com",
            databaseURL: "https://kassa-e757b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "kassa-e757b",
            storageBucket: "kassa-e757b.firebasestorage.app",
            messagingSenderId: "419179767043",
            appId: "1:419179767043:web:d6aa42b4398d99402b536"
        };

        // Swish-konfiguration
        const SWISH_NUMBER = '1236828156';
        const SWISH_MESSAGE = 'Sjöstadskaféet';

        let cartItems = [];
        let swishQrCode = null;

        // Initiera Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Lyssna på anslutningsstatus
        const statusEl = document.getElementById('status');
        database.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() === true) {
                statusEl.textContent = 'Ansluten';
                statusEl.className = 'status-indicator connected';
            } else {
                statusEl.textContent = 'Frånkopplad';
                statusEl.className = 'status-indicator disconnected';
            }
        });

        // Lyssna på orderändringar från kassan
        database.ref('currentOrder').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data && data.items) {
                cartItems = data.items;
            } else {
                cartItems = [];
            }
            renderCart();
        });

        function renderCart() {
            const cartEl = document.getElementById('cart');
            const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            if (cartItems.length === 0) {
                cartEl.innerHTML = '<div class="empty-cart">Väntar på order...</div>';
                document.getElementById('total-section').classList.add('no-items');
            } else {
                document.getElementById('total-section').classList.remove('no-items');
                cartEl.innerHTML = cartItems.map(item => `
                    <div class="cart-item">
                        <span class="cart-item-name">${item.name}</span>
                        <span class="cart-item-details">
                            ${item.quantity} × ${item.price} kr
                            <span class="cart-item-price">${item.price * item.quantity} kr</span>
                        </span>
                    </div>
                `).join('');
            }

            document.getElementById('total-amount').textContent = `${total} kr`;
            updateSwishQR(total);
        }

        function updateSwishQR(total) {
            const qrSection = document.getElementById('qr-section');
            const qrContainer = document.getElementById('qr-container');
            const qrAmount = document.getElementById('qr-amount');

            if (total === 0) {
                qrSection.classList.add('hidden');
                return;
            }

            qrSection.classList.remove('hidden');
            qrAmount.textContent = `${total} kr`;

            // Rensa tidigare QR-kod
            qrContainer.innerHTML = '';

            // Swish-payload: C<nummer>;<belopp>;<meddelande>;
            const payload = `C${SWISH_NUMBER};${total};${encodeURIComponent(SWISH_MESSAGE)};`;

            // Generera QR-kod (300x300 för display)
            swishQrCode = new QRCode(qrContainer, {
                text: payload,
                width: 300,
                height: 300,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.L
            });
        }

        // Initialisera tom vy
        renderCart();
    </script>
</body>
</html>
